# 📐 项目架构图

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户浏览器                                │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                     前端应用 (React)                       │  │
│  │  - 登录/注册页面                                           │  │
│  │  - 素材管理界面                                            │  │
│  │  - 选题管理界面                                            │  │
│  │  - 视频管理界面                                            │  │
│  │  - AI配置界面                                             │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            ↓ HTTPS                             │
└─────────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│                      阿里云 Nginx 反向代理                        │
│                     (SSL证书 / 负载均衡)                         │
└─────────────────────────────────────────────────────────────────┘
                             ↓
        ┌────────────────────┴────────────────────┐
        ↓                                         ↓
┌──────────────────┐                    ┌──────────────────┐
│   前端静态文件    │                    │   后端API服务     │
│   (Nginx)        │                    │   (Nest.js)      │
│                  │                    │   PM2 管理        │
│  /index.html     │                    │  Port: 3000      │
│  /assets/*       │                    │                  │
└──────────────────┘                    └──────────────────┘
                                               ↓
                        ┌──────────────────────┴─────────────────────┐
                        ↓                      ↓                     ↓
              ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
              │   阿里云 RDS      │  │   阿里云 OSS      │  │   第三方AI API    │
              │   (MySQL 8.0)    │  │  (对象存储)       │  │   (豆包/OpenAI)   │
              │                  │  │                  │  │                  │
              │  - users         │  │  - 图片存储       │  │  - 图像分析       │
              │  - materials     │  │  - 视频存储       │  │  - 文本生成       │
              │  - topics        │  │  - 头像存储       │  │                  │
              │  - videos        │  │                  │  │                  │
              │  - ai_providers  │  │                  │  │                  │
              └──────────────────┘  └──────────────────┘  └──────────────────┘
```

---

## 📂 后端模块架构

```
Backend (Nest.js)
│
├── 🔐 Auth Module (认证模块)
│   ├── JWT Strategy
│   ├── Passport Guards
│   └── BCrypt 密码加密
│
├── 👤 Users Module (用户模块)
│   ├── 个人信息管理
│   ├── 头像上传
│   └── 密码修改
│
├── 📚 Materials Module (素材模块)
│   ├── CRUD 操作
│   ├── 分页查询
│   ├── 搜索过滤
│   ├── 使用统计
│   └── OSS 集成
│
├── 💡 Topics Module (选题模块)
│   ├── CRUD 操作
│   ├── 状态管理 (pending/inProgress/completed)
│   ├── 优先级排序
│   └── 统计分析
│
├── 🎬 Videos Module (视频模块)
│   ├── CRUD 操作
│   ├── 多平台数据记录
│   ├── 数据分析 (播放量/点赞/完播率)
│   └── 素材关联
│
├── 🤖 AI Providers Module (AI配置模块)
│   ├── 多模型管理
│   ├── 视觉/文本模型独立配置
│   ├── 默认模型设置
│   └── API密钥安全存储
│
└── 📁 OSS Module (文件上传模块)
    ├── 阿里云 OSS SDK
    ├── 文件上传
    ├── URL 生成
    └── 文件删除
```

---

## 🗄️ 数据库结构

```
MySQL Database: video_production_db
│
├── users (用户表)
│   ├── id (主键)
│   ├── username (用户名, 唯一)
│   ├── email (邮箱, 唯一)
│   ├── password (加密密码)
│   ├── nickname (昵称)
│   ├── avatar (头像URL)
│   ├── role (角色: user/admin)
│   └── timestamps
│
├── materials (素材表)
│   ├── id (主键)
│   ├── user_id (外键 → users.id)
│   ├── name (素材名称)
│   ├── scene (场景描述)
│   ├── tags (JSON数组)
│   ├── duration (时长)
│   ├── note (备注)
│   ├── thumbnail (缩略图URL)
│   ├── file_type (image/video)
│   ├── usage_count (使用次数)
│   ├── last_used (最后使用日期)
│   └── timestamps
│
├── topics (选题表)
│   ├── id (主键)
│   ├── user_id (外键 → users.id)
│   ├── title (选题标题)
│   ├── description (描述)
│   ├── source (来源)
│   ├── status (pending/inProgress/completed)
│   ├── priority (low/medium/high)
│   ├── difficulty (1-3星)
│   └── timestamps
│
├── videos (成品视频表)
│   ├── id (主键)
│   ├── user_id (外键 → users.id)
│   ├── topic_id (外键 → topics.id, 可空)
│   ├── title (视频标题)
│   ├── publish_date (发布日期)
│   ├── platform (平台)
│   ├── views (播放量)
│   ├── likes (点赞数)
│   ├── comments (评论数)
│   ├── shares (分享数)
│   ├── completion_rate (完播率)
│   ├── material_ids (JSON数组)
│   └── timestamps
│
└── ai_providers (AI配置表)
    ├── id (主键)
    ├── user_id (外键 → users.id)
    ├── name (模型名称)
    ├── type (模型类型)
    ├── icon (图标)
    ├── description (描述)
    ├── vision_config (JSON: 视觉模型配置)
    ├── text_config (JSON: 文本模型配置)
    ├── is_default (是否默认)
    ├── enabled (是否启用)
    └── timestamps
```

---

## 🔄 数据流转图

### 用户登录流程

```
用户输入账号密码
    ↓
POST /api/auth/login
    ↓
后端验证用户名和密码 (BCrypt)
    ↓
生成 JWT Token (包含用户ID)
    ↓
返回 Token 和用户信息
    ↓
前端保存到 localStorage
    ↓
后续请求携带 Token (Bearer)
    ↓
后端 JWT Guard 验证 Token
    ↓
解析出用户ID
    ↓
注入到 Request.user
```

### 素材上传流程

```
用户选择文件
    ↓
前端压缩图片/提取视频帧
    ↓
FormData 上传到 /api/oss/upload
    ↓
后端接收 Multer File
    ↓
调用 阿里云 OSS SDK
    ↓
上传到 OSS Bucket
    ↓
返回 OSS URL
    ↓
(可选) 调用 AI 分析图片
    ↓
POST /api/materials (携带 OSS URL)
    ↓
保存到 MySQL materials 表
    ↓
返回完整素材数据
```

### 数据统计流程

```
GET /api/materials/stats/summary
    ↓
后端 TypeORM 聚合查询
    ↓
COUNT(*) GROUP BY file_type
    ↓
返回统计数据
{
  total: 100,
  imageCount: 60,
  videoCount: 40
}
```

---

## 🔒 安全机制

### 认证与授权

```
┌──────────────────────────────────────┐
│  1. 用户登录                          │
│     ↓                                │
│  2. BCrypt 验证密码                  │
│     ↓                                │
│  3. 生成 JWT Token                   │
│     - Payload: {userId, username}    │
│     - Secret: 环境变量               │
│     - Expires: 7天                   │
│     ↓                                │
│  4. 前端每次请求携带 Token            │
│     Authorization: Bearer xxx        │
│     ↓                                │
│  5. JWT Guard 验证 Token             │
│     ↓                                │
│  6. 解析出用户ID                     │
│     ↓                                │
│  7. 数据权限过滤 (WHERE user_id=?)   │
└──────────────────────────────────────┘
```

### 数据权限

- ✅ 所有数据按用户隔离 (user_id 过滤)
- ✅ API 强制要求 JWT Token
- ✅ TypeORM WHERE 条件自动加入 user_id
- ✅ 用户只能操作自己的数据

---

## 🚀 部署架构

### 开发环境

```
localhost:5173 (前端 Vite Dev Server)
     ↓ API 请求
localhost:3000 (后端 Nest.js Dev Server)
     ↓
localhost:3306 (本地 MySQL)
```

### 生产环境 (阿里云)

```
your-domain.com (前端)
     ↓ Nginx 静态文件服务
     ↓
api.your-domain.com (后端 API)
     ↓ Nginx 反向代理
     ↓
localhost:3000 (PM2 进程)
     ↓
rds-xxxxxx.mysql.rds.aliyuncs.com:3306 (RDS)
     ↓
bucket.oss-cn-hangzhou.aliyuncs.com (OSS)
```

---

## 📊 性能优化

### 数据库优化

- ✅ 主键索引 (id)
- ✅ 外键索引 (user_id, topic_id)
- ✅ 查询索引 (created_at, status)
- ✅ 唯一索引 (username, email)

### 接口优化

- ✅ 分页查询 (page, limit)
- ✅ 条件过滤 (search)
- ✅ 字段筛选 (只返回需要的字段)
- ✅ 统计查询缓存 (可考虑 Redis)

### 文件优化

- ✅ 图片压缩 (前端压缩后上传)
- ✅ OSS CDN 加速
- ✅ 懒加载图片

---

## 🔧 技术选型理由

| 技术 | 选型 | 理由 |
|------|------|------|
| **后端框架** | Nest.js | 企业级、模块化、TypeScript、依赖注入 |
| **ORM** | TypeORM | 类型安全、Active Record、支持MySQL |
| **数据库** | MySQL 8.0 | 稳定、ACID、关系型、阿里云RDS |
| **认证** | JWT + Passport | 无状态、可扩展、标准化 |
| **文件存储** | 阿里云 OSS | 高可用、CDN、成本低 |
| **前端框架** | React 18 | 生态完善、组件化、Hooks |
| **HTTP 客户端** | Axios | 拦截器、自动转换、取消请求 |
| **进程管理** | PM2 | 守护进程、日志、负载均衡 |

---

## 📈 可扩展性

### 水平扩展

```
Nginx 负载均衡
     ↓
┌────────┬────────┬────────┐
│ Node 1 │ Node 2 │ Node 3 │
└────────┴────────┴────────┘
         ↓
    RDS MySQL (读写分离)
         ↓
    Redis (缓存层)
```

### 功能扩展

- 📅 定时任务 (Nest Schedule)
- 📧 邮件通知 (Nodemailer)
- 📱 消息推送 (WebSocket)
- 📊 数据导出 (Excel)
- 🔍 全文搜索 (Elasticsearch)

---

这个架构设计保证了：
- ✅ 高性能
- ✅ 高可用
- ✅ 易扩展
- ✅ 易维护
- ✅ 安全可靠
